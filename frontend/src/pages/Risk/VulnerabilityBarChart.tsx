import React, { useEffect, useRef, useState } from 'react';
import { useHistory } from 'react-router-dom';
import { ResponsiveBar, BarDatum } from '@nivo/bar';
import { Paper, Tooltip } from '@mui/material';
import { Point } from './Risk';
import * as RiskStyles from './style';
import { getSeverityColor, getServicesColor, getTooltipColor } from './utils';

// Define the type to match the BarDatum structure
interface BarData extends BarDatum {
  id: string;
  value: number;
}

const VulnerabilityBarChart = (props: {
  title: string;
  data: Point[];
  colors: any;
  type: string;
}) => {
  const history = useHistory();
  const { title, data, type } = props;
  const { cardRoot, cardSmall, header, chartSmall } = RiskStyles.classesRisk;
  const [ariaLabel, setAriaLabel] = useState('');
  const ariaLiveRef = useRef<HTMLDivElement>(null);

  const CustomBarLayer = ({ bars }: { bars: any[]; [key: string]: any }) => {
    return bars.map((bar) => (
      <Tooltip
        title={`${bar.data.value} ${bar.data.indexValue} level severities in this organization.`}
        placement="right"
        arrow
        key={bar.index}
      >
        <g key={bar.key}>
          <rect
            role="button"
            key={bar.key}
            x={bar.x}
            y={bar.y}
            width={bar.width}
            height={bar.height}
            fill={bar.color}
            tabIndex={0}
            aria-label={`${bar.data.value} ${bar.data.indexValue} level severities in this organization.`}
            onClick={() => {
              //To-Do: Fix onClick so that it correctly sends user to All Vulns table with severity level as a filter.
              if (type === 'vulns') {
                history.push(
                  `/inventory/vulnerabilities?severity=${bar.indexValue}`
                );
              }
            }}
          />
        </g>
      </Tooltip>
    ));
  };

  // Map data to BarData structure
  const mappedData: BarData[] = data.map((d) => ({
    id: d.id,
    value: d.value
  }));

  // Sort the data to ensure "Low", "Medium", and "High" appear in the desired order
  const sortedData = [...mappedData].sort((a, b) => {
    const order = ['Low', 'Medium', 'High'];
    return order.indexOf(a.id) - order.indexOf(b.id);
  });

  useEffect(() => {
    const label =
      `${title} bar chart. ` +
      sortedData
        .map(
          (point) =>
            `${point.id}: ${point.value} (${(
              (point.value /
                sortedData.reduce((acc, curr) => acc + curr.value, 0)) *
              100
            ).toFixed(2)}%)`
        )
        .join(', ');
    setAriaLabel(label);
  }, [title, sortedData]);

  const getColor = (indexValue: string) => {
    const severityColor = getSeverityColor({ id: indexValue });
    const serviceColor = getServicesColor({ id: indexValue });
    const color =
      indexValue === 'Low' || indexValue === 'Medium' || indexValue === 'High'
        ? severityColor
        : serviceColor;
    return color;
  };

  const getTextColor = () => getTooltipColor();

  return (
    <Paper elevation={0} className={cardRoot}>
      <div className={cardSmall}>
        <div className={header}>
          <h2>{title}</h2>
        </div>
        <div className={chartSmall} role="img" aria-label={ariaLabel}>
          <div
            ref={ariaLiveRef}
            aria-live="polite"
            style={{
              position: 'absolute',
              width: '1px',
              height: '1px',
              overflow: 'hidden',
              clip: 'rect(1px, 1px, 1px, 1px)'
            }}
          >
            {ariaLabel}
          </div>
          <ResponsiveBar
            data={sortedData}
            keys={['value']}
            indexBy="id"
            margin={{ top: 50, right: 50, bottom: 50, left: 60 }}
            padding={0.3}
            colors={({ indexValue }) => getColor(String(indexValue))} // Ensure indexValue is used
            colorBy="indexValue" // Use indexValue directly for color assignment
            borderColor={{ from: 'color', modifiers: [['darker', 1.6]] }}
            axisTop={null}
            axisRight={null}
            axisBottom={{
              tickSize: 5,
              tickPadding: 5,
              tickRotation: 0,
              legend: 'ID',
              legendPosition: 'middle',
              legendOffset: 32
            }}
            axisLeft={{
              tickSize: 5,
              tickPadding: 5,
              tickRotation: 0,
              legend: 'Value',
              legendPosition: 'middle',
              legendOffset: -40
            }}
            labelSkipWidth={12}
            labelSkipHeight={12}
            labelTextColor={getTextColor()}
            isInteractive={true} // Ensure tooltips are enabled
            layers={[
              'grid',
              'axes',
              CustomBarLayer,
              'markers',
              'legends',
              'annotations'
            ]}
            ariaLabel={'Severity Levels - y-axis: Value, x-axis: ID'}
            isFocusable
          />
        </div>
      </div>
    </Paper>
  );
};

export default VulnerabilityBarChart;
